/*!
 * SonicWS
 * (c) 2025 Lily (liwybloc)
 * Released under the Apache-2.0 License
 * https://www.apache.org/licenses/LICENSE-2.0
 */
(()=>{"use strict";var t={95:(t,e)=>{Object.defineProperty(e,"__esModule",{value:!0}),e.PacketHolder=void 0;e.PacketHolder=class{constructor(t){this.key=1,this.keys={},this.tags={},this.packetMap={},t&&(this.packets=t,this.holdPackets(t))}createKey(t){this.keys[t]=this.key,this.tags[this.key]=t,this.key++}holdPackets(t){for(const e of t)this.createKey(e.tag),this.packetMap[e.tag]=e}getKey(t){if(!(t in this.keys))throw new Error(`Not a valid tag: ${t}`);return this.keys[t]}getTag(t){return this.tags[t]}getPacket(t){if(!(t in this.packetMap))throw new Error("Unknown packet tag: "+t);return this.packetMap[t]}hasKey(t){return t in this.tags}hasTag(t){return t in this.keys}getKeys(){return this.keys}getTagMap(){return this.tags}getTags(){return Object.values(this.tags)}getPackets(){return this.packets}serialize(){return this.packets.map(t=>t.serialize()).flat()}}},204:function(t,e,r){var a=this&&this.__awaiter||function(t,e,r,a){return new(r||(r=Promise))(function(n,s){function i(t){try{c(a.next(t))}catch(t){s(t)}}function o(t){try{c(a.throw(t))}catch(t){s(t)}}function c(t){var e;t.done?n(t.value):(e=t.value,e instanceof r?e:new r(function(t){t(e)})).then(i,o)}c((a=a.apply(t,e||[])).next())})};Object.defineProperty(e,"__esModule",{value:!0}),e.SonicWSCore=void 0;const n=r(95),s=r(943),i=r(876),o=r(215),c=r(925),h=r(341),l=r(817);e.SonicWSCore=class{constructor(t,e){this.clientPackets=new n.PacketHolder,this.serverPackets=new n.PacketHolder,this.pastKeys=!1,this.readyListeners=[],this.id=-1,this._timers={},this.reading=!1,this.socket=t,this.listeners={message:[],close:[],event:{}},this.preListen={},this.batcher=new h.BatchHelper,this.invalidPacket=this.invalidPacket.bind(this),this.serverKeyHandler=this.serverKeyHandler.bind(this),this.messageHandler=this.messageHandler.bind(this),this.socket.addEventListener("message",this.serverKeyHandler),this.socket.addEventListener("close",t=>{this.listeners.close.forEach(e=>e(t)),Object.values(this._timers).forEach(clearTimeout)}),this.bufferHandler=e}serverKeyHandler(t){return a(this,void 0,void 0,function*(){if(this.reading)return this.messageHandler(t);this.reading=!0;const e=yield this.bufferHandler(t);if(e.length<3||(0,l.as8String)(e.slice(0,3))!=o.SERVER_SUFFIX)throw this.socket.close(1e3),new Error("The server requested is not a Sonic WS server.");const r=e[3];if(r!=o.VERSION)throw this.socket.close(1e3),new Error(`Version mismatch: ${r>o.VERSION?"client":"server"} is outdated (server: ${r}, client: ${o.VERSION})`);const[a,n]=(0,s.readVarInt)(e,4);this.id=n;const[i,h]=(0,s.readVarInt)(e,a),u=e.slice(i,i+h);this.clientPackets.holdPackets(c.Packet.deserializeAll(u,!0));const d=e.slice(i+h,e.length);this.serverPackets.holdPackets(c.Packet.deserializeAll(d,!0)),this.batcher.registerSendPackets(this.clientPackets,this),Object.keys(this.preListen).forEach(t=>this.preListen[t].forEach(e=>{if(!this.serverPackets.hasTag(t))return console.error(new Error(`The server does not send the packet with tag "${t}"!`));this.listen(t,e)})),this.preListen=null,this.pastKeys=!0,this.readyListeners.forEach(t=>t()),this.readyListeners=null,this.socket.removeEventListener("message",this.serverKeyHandler),this.socket.addEventListener("message",this.messageHandler)})}invalidPacket(t){throw console.log(t),new Error("An error occured with data from the server!! This is probably my fault.. make an issue at https://github.com/cutelittlelily/sonic-ws")}listenPacket(t,e){const r=this.listeners.event[e];if(!r)return console.warn("Warn: No listener for packet "+this.serverPackets.getTag(e));(0,i.listenPacket)(t,r,this.invalidPacket)}messageHandler(t){return a(this,void 0,void 0,function*(){const e=yield this.bufferHandler(t);if(this.listeners.message.forEach(t=>t(e)),e.length<1)return;const r=e[0],a=e.slice(1),n=this.serverPackets.getPacket(this.serverPackets.getTag(r));if(0==n.dataBatching)return void this.listenPacket(n.listen(a,null),r);const s=h.BatchHelper.unravelBatch(n,a,null);if("string"==typeof s)return this.invalidPacket(s);s.forEach(t=>this.listenPacket(t,r))})}listen(t,e){const r=this.serverPackets.getKey(t);null!=r?(this.listeners.event[r]||(this.listeners.event[r]=[]),this.listeners.event[r].push(e)):console.log("Key is not available on server: "+t)}raw_onmessage(t){this.listeners.message.push(t)}send(t,...e){const[r,a,n]=(0,i.processPacket)(this.clientPackets,t,e);0==n.dataBatching?this.raw_send((0,l.toPacketBuffer)(r,a)):this.batcher.batchPacket(r,a)}on_ready(t){this.pastKeys?t():this.readyListeners.push(t)}on_close(t){this.listeners.close.push(t)}on(t,e){if(this.socket.readyState!==WebSocket.OPEN)return this.preListen[t]||(this.preListen[t]=[]),void this.preListen[t].push(e);this.listen(t,e)}raw_send(t){this.socket.send(t)}setTimeout(t,e){const r=setTimeout(()=>{t(),this.clearTimeout(r)},e);return this.setTimer(r),r}setInterval(t,e){const r=setInterval(t,e);return this.setTimer(r),r}setTimer(t){this._timers[t]=t}clearTimeout(t){clearTimeout(t),delete this._timers[t]}clearInterval(t){this.clearTimeout(t)}close(t,e){this.socket.close(t,e)}}},215:(t,e,r)=>{Object.defineProperty(e,"__esModule",{value:!0}),e.SERVER_SUFFIX_NUMS=e.SERVER_SUFFIX=e.VERSION=void 0;const a=r(958);e.VERSION=12,e.SERVER_SUFFIX="SWS",e.SERVER_SUFFIX_NUMS=(0,a.processCharCodes)(e.SERVER_SUFFIX)},282:(t,e)=>{Object.defineProperty(e,"__esModule",{value:!0}),e.splitArray=function(t,e){const r=[];for(let a=0;a<t.length;a+=e)r.push(t.slice(a,a+e));return r}},341:(t,e,r)=>{Object.defineProperty(e,"__esModule",{value:!0}),e.BatchHelper=void 0;const a=r(817),n=r(943);e.BatchHelper=class{constructor(){this.batchTimes={},this.batchTimeouts={},this.batchedData={}}registerSendPackets(t,e){this.conn=e,t.getTags().forEach(e=>{const r=t.getPacket(e);if(0==r.dataBatching)return;const a=t.getKey(e);this.initiateBatch(a,r.dataBatching)})}initiateBatch(t,e){this.batchedData[t]=[],this.batchTimes[t]=e}startBatch(t){this.batchTimeouts[t]=this.conn.setTimeout(()=>{this.conn.raw_send((0,a.toPacketBuffer)(t,this.batchedData[t])),this.batchedData[t]=[],delete this.batchTimeouts[t]},this.batchTimes[t])}batchPacket(t,e){const r=this.batchedData[t];r.push(...(0,n.convertVarInt)(e.length)),e.forEach(t=>r.push(t)),this.batchTimeouts[t]||this.startBatch(t)}static unravelBatch(t,e,r){const a=[];for(let s=0;s<e.length;){if(t.maxBatchSize>0&&a.length>t.maxBatchSize)return"Too big of batch";const[i,o]=(0,n.readVarInt)(e,s);if(s=i,s+o>e.length)return"Tampered batch length";const c=e.slice(s,s+=o),h=t.listen(c,r);if("string"==typeof h)return"Batched packet: "+h;a.push([h[0],!t.dontSpread])}return a}}},475:(t,e,r)=>{Object.defineProperty(e,"__esModule",{value:!0}),e.createValidator=u,e.createReceiveProcessor=d,e.createSendProcessor=p,e.createObjSendProcessor=function(t){const e=t.type,r=e.length,a=e.map(t=>p(t));return t=>{let e=[];for(let s=0;s<r;s++){const r=t[s],i=a[s](Array.isArray(r)?r:[r]);if(i.length>n.MAX_UVARINT)throw new Error(`Cannot send ${i.length}/${n.MAX_UVARINT} bytes of data!`);e.push(...(0,n.convertVarInt)(i.length)),i.forEach(t=>e.push(t))}return e}},e.createObjReceiveProcessor=function(t){const e=t.type,r=t.dataMax,a=e.map((e,a)=>d(e,t.enumData,r[a]));return(t,r)=>{let i=0,o=0,c=[];for(;i<t.length;){const[h,l]=(0,n.readVarInt)(t,i);i=h;const u=t.subarray(i,i+=l);c.push(a[c.length](u,r[c.length],e[c.length]==s.PacketType.ENUMS?o++:0))}return c}},e.createObjValidator=function(t){const e=t.type,r=t.dataMax,a=t.dataMin,i=e.map((e,n)=>u(e,r[n],a[n],t));return t=>{let r=0,a=0,o=[];for(;r<t.length;){if(o.length>e.length)return!1;const[c,h]=(0,n.readVarInt)(t,r);if(r=c,h+r>t.length)return!1;const l=t.subarray(r,r+=h),u=i[o.length](l,e[o.length]==s.PacketType.ENUMS?a++:0);if(!1===u)return!1;o.push(u)}return o}};const a=r(282),n=r(943),s=r(798),i=r(817),o=r(958);function c(t,e){return r=>r.length>=e&&r.length<=t}function h(t,e){return e*=2,t*=2,r=>r.length>=e&&r.length<=t&&r.length%2==0}function l(t,e){return r=>{if(0==r.length)return!1;let a=0,s=0,i=[];for(;s<r.length;){const[e,o]=(0,n.readVarInt)(r,s);if(s=e,i.push(o),++a>t)return!1}return!(a<e)&&i}}function u(t,e,r,a){switch(t){case s.PacketType.NONE:return t=>0==t.length;case s.PacketType.RAW:return()=>{};case s.PacketType.ENUMS:return(t,n)=>{if(t.length<r||t.length>e||n>=a.enumData.length)return!1;console.log("~~ENUM~~",a,a.enumData,n);const s=a.enumData[n];for(let e=0;e<t.length;e++)if(s.values.length<=t[e])return!1};case s.PacketType.BYTES:case s.PacketType.UBYTES:return c(e,r);case s.PacketType.SHORTS:case s.PacketType.USHORTS:return h(e,r);case s.PacketType.VARINT:case s.PacketType.UVARINT:case s.PacketType.DELTAS:return l(e,r);case s.PacketType.FLOATS:return t=>{if(t.length%4!=0)return!1;const a=t.length*n.ONE_FOURTH;return!(a>e||a<r)&&void 0};case s.PacketType.DOUBLES:return t=>{if(t.length%8!=0)return!1;const a=t.length*n.ONE_EIGHT;return!(a>e||a<r)&&void 0};case s.PacketType.BOOLEANS:{const t=Math.floor(r*n.ONE_EIGHT),a=Math.floor(e*n.ONE_EIGHT);return e=>e.length>=t&&e.length<=a}case s.PacketType.STRINGS_ASCII:return t=>{let a=0,s=0,i=[];for(;s<t.length;){if(a++,a>e)return!1;const[r,o]=(0,n.readVarInt)(t,s);if(s=r+o,i.push(o),s>t.length)return!1}return!(a<r)&&i};case s.PacketType.STRINGS_UTF16:return t=>{let a=0,s=0,i=[];for(;s<t.length;){if(a++,a>e)return!1;const[r,o]=(0,n.readVarInt)(t,s);if(s=r+2*o,i.push(o),s>t.length)return!1}return!(a<r)&&i};default:throw new Error("Unknown type: "+t)}}function d(t,e,r){switch(t){case s.PacketType.NONE:return()=>{};case s.PacketType.RAW:return t=>t;case s.PacketType.BYTES:return t=>Array.from(t).map(n.demapZigZag);case s.PacketType.UBYTES:return t=>Array.from(t);case s.PacketType.SHORTS:return t=>(0,i.splitBuffer)(t,2).map(t=>(0,n.demapShort_ZZ)(t));case s.PacketType.USHORTS:return t=>(0,i.splitBuffer)(t,2).map(t=>(0,n.fromShort)(t));case s.PacketType.VARINT:return(t,e)=>e.map(n.demapZigZag);case s.PacketType.UVARINT:return(t,e)=>e;case s.PacketType.DELTAS:return(t,e)=>e.map((t,r)=>e[r]=(e[r-1]||0)+(0,n.demapZigZag)(t));case s.PacketType.FLOATS:return t=>(0,i.splitBuffer)(t,4).map(n.deconvertFloat);case s.PacketType.DOUBLES:return t=>(0,i.splitBuffer)(t,8).map(n.deconvertDouble);case s.PacketType.BOOLEANS:return t=>Array.from(t).map(t=>(0,n.decompressBools)(t)).flat().splice(0,r);case s.PacketType.ENUMS:return(t,r,a)=>{const n=e[a];return Array.from(t).map(t=>n.values[t])};case s.PacketType.STRINGS_ASCII:return(t,e)=>{let r=0;return e.map(e=>(0,i.as8String)(t.subarray(++r,r+=e)))};case s.PacketType.STRINGS_UTF16:return(t,e)=>{let r=0;return e.map(e=>(0,i.as16String)(t.subarray(++r,r+=2*e)))};default:throw new Error("Unknown type: "+t)}}function p(t){switch(t){case s.PacketType.NONE:return()=>[];case s.PacketType.RAW:return t=>Array.from(t);case s.PacketType.ENUMS:return t=>t;case s.PacketType.BYTES:return t=>t.map(n.mapZigZag);case s.PacketType.UBYTES:return t=>t.map(n.toByte);case s.PacketType.SHORTS:return t=>t.map(n.mapShort_ZZ).flat();case s.PacketType.USHORTS:return t=>t.map(n.toShort).flat();case s.PacketType.VARINT:return t=>t.map(t=>(0,n.convertVarInt)((0,n.mapZigZag)(t))).flat();case s.PacketType.UVARINT:return t=>t.map(n.convertVarInt).flat();case s.PacketType.DELTAS:return t=>t.map((e,r)=>(0,n.convertVarInt)((0,n.mapZigZag)(e-(t[r-1]||0)))).flat();case s.PacketType.FLOATS:return t=>t.map(n.convertFloat).flat();case s.PacketType.DOUBLES:return t=>t.map(n.convertDouble).flat();case s.PacketType.BOOLEANS:return t=>(0,a.splitArray)(t,8).map(t=>(0,n.compressBools)(t)).flat();case s.PacketType.STRINGS_ASCII:return t=>{const e=[];for(const r of t){const t=String(r);e.push(...(0,n.convertVarInt)(t.length));const a=(0,o.processCharCodes)(t),s=a.find(t=>t>n.MAX_BYTE);if(s)throw new Error(`Cannot store code ${s} (${String.fromCharCode(s)}) in a UTF-8 String! Use STRINGS_UTF16.`);a.map(t=>e.push(t))}return e};case s.PacketType.STRINGS_UTF16:return t=>{const e=[];for(const r of t){const t=String(r);e.push(...(0,n.convertVarInt)(t.length)),(0,o.processCharCodes)(t).map(t=>e.push(...(0,o.splitCodePoint)(t).map(t=>(0,n.toShort)(t)).flat()))}return e};default:throw new Error("Unknown type: "+t)}}},658:function(t,e,r){var a=this&&this.__awaiter||function(t,e,r,a){return new(r||(r=Promise))(function(n,s){function i(t){try{c(a.next(t))}catch(t){s(t)}}function o(t){try{c(a.throw(t))}catch(t){s(t)}}function c(t){var e;t.done?n(t.value):(e=t.value,e instanceof r?e:new r(function(t){t(e)})).then(i,o)}c((a=a.apply(t,e||[])).next())})};Object.defineProperty(e,"__esModule",{value:!0});const n=r(673),s=r(876),i=r(204);window.SonicWS=class extends i.SonicWSCore{constructor(t,e){super(new WebSocket(t,e),t=>a(this,void 0,void 0,function*(){return new Uint8Array(yield t.data.arrayBuffer())}))}WrapEnum(t,e){return(0,n.WrapEnum)(t,e)}FlattenData(t){return(0,s.FlattenData)(t)}UnFlattenData(t){return(0,s.UnFlattenData)(t)}}},673:(t,e,r)=>{Object.defineProperty(e,"__esModule",{value:!0}),e.SET_PACKAGES=e.ENUM_KEY_TO_TAG=e.ENUM_TAG_TO_KEY=e.MAX_ENUM_SIZE=void 0,e.DefineEnum=function(t,r){const a=e.SET_PACKAGES[t];if(a){if(a.values.find((t,e)=>r[e]!=t))throw new Error(`Pre-existing enum package of tag '${t}' is set and different!`);return a}if(r.length>e.MAX_ENUM_SIZE)throw new Error(`An enum can only hold ${e.MAX_ENUM_SIZE} possible values.`);return e.ENUM_TAG_TO_KEY[t]=Object.fromEntries(r.map((t,e)=>[t,e])),e.ENUM_KEY_TO_TAG[t]=Object.fromEntries(r.map((t,e)=>[e,t])),e.SET_PACKAGES[t]=new n.EnumPackage(t,r)},e.WrapEnum=function(t,r){if(!(r in e.ENUM_TAG_TO_KEY[t]))throw new Error(`Value "${r}" does not exist in enum "${t}"`);return e.ENUM_TAG_TO_KEY[t][r]};const a=r(943),n=r(977);e.MAX_ENUM_SIZE=a.MAX_BYTE,e.ENUM_TAG_TO_KEY={},e.ENUM_KEY_TO_TAG={},e.SET_PACKAGES={}},798:(t,e)=>{var r;Object.defineProperty(e,"__esModule",{value:!0}),e.PacketType=void 0,function(t){t[t.NONE=0]="NONE",t[t.RAW=1]="RAW",t[t.STRINGS_ASCII=2]="STRINGS_ASCII",t[t.STRINGS_UTF16=3]="STRINGS_UTF16",t[t.STRINGS=2]="STRINGS",t[t.ENUMS=4]="ENUMS",t[t.BYTES=5]="BYTES",t[t.UBYTES=6]="UBYTES",t[t.SHORTS=7]="SHORTS",t[t.USHORTS=8]="USHORTS",t[t.VARINT=9]="VARINT",t[t.UVARINT=10]="UVARINT",t[t.DELTAS=11]="DELTAS",t[t.FLOATS=12]="FLOATS",t[t.DOUBLES=13]="DOUBLES",t[t.BOOLEANS=14]="BOOLEANS"}(r||(e.PacketType=r={}))},817:(t,e,r)=>{Object.defineProperty(e,"__esModule",{value:!0}),e.toPacketBuffer=function(t,e){const r=new Uint8Array(1+e.length);return r[0]=t,r.set(e,1),r},e.splitBuffer=i,e.as8String=function(t){return(0,s.convertCharCodes)(Array.from(t))},e.as16String=function(t){const e=i(t,2).map(t=>(0,n.fromShort)(t));return(0,s.convertCodePoints)(e)},e.stringifyBuffer=function(t){return`<Buffer ${Array.from(t).map(t=>t.toString(16).padStart(2,"0")).join(" ")}>`};const a=r(282),n=r(943),s=r(958);function i(t,e){return(0,a.splitArray)(Array.from(t),e)}},876:(t,e,r)=>{Object.defineProperty(e,"__esModule",{value:!0}),e.processPacket=function(t,e,r){const a=t.getKey(e),n=t.getPacket(e);if(n.autoFlatten)r=u(r[0]);else{if(r.length>n.maxSize)throw new Error(`Packet "${e}" only allows ${n.maxSize} values!`);if(r.length<n.minSize)throw new Error(`Packet "${e}" requires at least ${n.minSize} values!`)}if(n.object){if(r=r.map(t=>Array.isArray(t)?t:[t]),!n.autoFlatten){const t=n.dataMin,a=n.dataMax;for(let n=0;n<t.length;n++){if(r[n].length<t[n])throw new Error(`Section ${n+1} of packet "${e}" requires at least ${t[n]} values!`);if(r[n].length>a[n])throw new Error(`Section ${n+1} of packet "${e}" only allows ${a[n]} values!`)}}}else{const t=r.find(t=>"object"==typeof t&&null!=t);t&&console.warn(`Passing an array will result in undefined behavior (${JSON.stringify(t)}). Spread the array with ...arr`)}return[a,r.length>0?n.processSend(r):[],n]},e.listenPacket=function(t,e,r){if("string"==typeof t)return r(t);const[a,n]=t;try{n&&Array.isArray(a)?e.forEach(t=>t(...a)):e.forEach(t=>t(a))}catch(t){r(t)}},e.CreatePacket=l,e.CreateObjPacket=function(t){let{tag:e,types:r,dataMaxes:s,dataMins:l,noDataRange:u=!1,dontSpread:d=!1,autoFlatten:p=!1,validator:f=null,dataBatching:T=0,maxBatchSize:S=10,rateLimit:E=0,enabled:m=!0}=t;for(const t of r)if(i(t))throw new Error(`Invalid packet type in "${e}" packet: ${t}`);u?(s=Array.from({length:r.length}).map(()=>o),l=Array.from({length:r.length}).map(()=>0)):(null==s?s=Array.from({length:r.length}).map(()=>1):Array.isArray(s)||(s=Array.from({length:r.length}).map(()=>s)),null==l?l=Array.from({length:r.length}).map((t,e)=>s[e]):Array.isArray(l)||(l=Array.from({length:r.length}).map(()=>l)));const g=s.map(c),y=l.map((t,e)=>r[e]==n.PacketType.NONE?0:h(t,g[e])),_=a.PacketSchema.object(r,g,y,d,p,T,S,E);return new a.Packet(e,_,f,m,!1)},e.CreateEnumPacket=function(t){const{tag:e,enumData:r,dataMax:a=1,dataMin:n=0,noDataRange:s=!1,dontSpread:i=!1,validator:o=null,dataBatching:c=0,maxBatchSize:h=10,rateLimit:u=0,enabled:d=!0}=t;return l({tag:e,type:r,dataMax:a,dataMin:n,noDataRange:s,dontSpread:i,validator:o,dataBatching:c,maxBatchSize:h,rateLimit:u,enabled:d})},e.FlattenData=u,e.UnFlattenData=function(t){var e,r;return null!==(r=null===(e=t[0])||void 0===e?void 0:e.map((e,r)=>t.map(t=>t[r])))&&void 0!==r?r:[]};const a=r(925),n=r(798),s=r(977);function i(t){return!("number"==typeof t&&t in n.PacketType||t instanceof s.EnumPackage)}const o=2048383;function c(t){return t<0?(console.warn("Having a data maximum below 0 does not do anything!"),0):t>o?(console.warn(`Only ${o} values can be sent on a type! Uhh make an issue if you want to send more.`),o):t}function h(t,e){return t<0?(console.warn("Having a data minimum below 0 does not do anything!"),0):t>e?(console.warn("Data minimum can not be higher than the data maximum!"),e):t}function l(t){let{tag:e,type:r=n.PacketType.NONE,dataMax:s=1,dataMin:l,noDataRange:u=!1,dontSpread:d=!1,validator:p=null,dataBatching:f=0,maxBatchSize:T=10,rateLimit:S=0,enabled:E=!0}=t;if(u?(l=0,s=o):null==l&&(l=r==n.PacketType.NONE?0:s),i(r))throw new Error(`Invalid packet type: ${r}`);const m=a.PacketSchema.single(r,c(s),h(l,s),d,f,T,S);return new a.Packet(e,m,p,E,!1)}function u(t){var e;if(null==t)return[];const r=t[0];if(null==r)return[];if(!Array.isArray(r))throw new Error(`Cannot flatten array: ${t}`);return null!==(e=r.map((e,r)=>t.map(t=>t[r])))&&void 0!==e?e:[]}},925:(t,e,r)=>{Object.defineProperty(e,"__esModule",{value:!0}),e.PacketSchema=e.Packet=void 0;const a=r(673),n=r(977),s=r(943),i=r(876),o=r(475),c=r(798),h=r(817),l=r(958);class u{constructor(t,e,r,a,n){this.tag=t,this.defaultEnabled=a,this.client=n,this.enumData=e.enumData,this.rateLimit=e.rateLimit,this.dontSpread=e.dontSpread,this.autoFlatten=e.autoFlatten,this.dataBatching=e.dataBatching,this.maxBatchSize=n?1/0:e.maxBatchSize,this.object=e.object,this.object?(this.type=e.types,this.dataMax=e.dataMaxes,this.dataMin=e.dataMins,this.maxSize=this.type.length,this.minSize=this.type.length,this.receiveProcessor=(0,o.createObjReceiveProcessor)(this),this.validator=(0,o.createObjValidator)(this),this.sendProcessor=(0,o.createObjSendProcessor)(this)):(this.type=e.type,this.dataMax=e.dataMax,this.dataMin=e.dataMin,this.maxSize=this.dataMax,this.minSize=this.dataMin,this.receiveProcessor=(0,o.createReceiveProcessor)(this.type,this.enumData,this.dataMax),this.validator=(0,o.createValidator)(this.type,this.dataMax,this.dataMin,this),this.sendProcessor=(0,o.createSendProcessor)(this.type)),this.processReceive=(t,e)=>this.receiveProcessor(t,e,0),this.processSend=t=>this.sendProcessor(t),this.validate=t=>this.validator(t,0),this.customValidator=r}listen(t,e){try{const r=this.validate(t);if(!this.client&&0==r)return"Invalid packet";const a=this.processReceive(t,r),n=this.autoFlatten?(0,i.UnFlattenData)(a):a;if(null!=this.customValidator)if(this.dontSpread){if(!this.customValidator(e,n))return"Didn't pass custom validator"}else if(!this.customValidator(e,...n))return"Didn't pass custom validator";return[n,!this.dontSpread]}catch(t){return console.error("There was an error processing the packet! This is probably my fault... report at https://github.com/cutelittlelily/sonic-ws",t),"Error: "+t}}serialize(){const t=[this.tag.length,...(0,l.processCharCodes)(this.tag),this.dontSpread?1:0,this.dataBatching,this.enumData.length,...this.enumData.map(t=>t.serialize()).flat()];return this.object?[...t,this.maxSize+1,this.autoFlatten?1:0,...this.dataMax.map(s.convertVarInt).flat(),...this.dataMin.map(s.convertVarInt).flat(),...this.type,this.tag.length]:[...t,0,...(0,s.convertVarInt)(this.dataMax),...(0,s.convertVarInt)(this.dataMin),this.type]}static readVarInts(t,e,r){const a=[];for(let n=0;n<r;n++){const[r,n]=(0,s.readVarInt)(t,e);e=r,a.push(n)}return[a,e]}static deserialize(t,e,r){const i=e,o=t[e++],l=(0,h.as8String)(t.slice(e,e+=o)),p=1==t[e++],f=t[e++],T=t[e++],S=[];for(let r=0;r<T;r++){const r=t[e++],s=(0,h.as8String)(t.slice(e,e+=r)),i=t[e++],o=[];for(let r=0;r<i;r++){const r=t[e++],a=t[e++],s=(0,h.as8String)(t.slice(e,e+=r));o.push(n.TYPE_CONVERSION_MAP[a](s))}S.push((0,a.DefineEnum)(s,o))}const E=t[e++]-1;if(-1!=E){const a=1==t[e++],[n,s]=this.readVarInts(t,e,E);e=s;const[o,h]=this.readVarInts(t,e,E);e=h;const T=Array.from(t.slice(e,e+=E));let m=0;const g=T.map(t=>t==c.PacketType.ENUMS?S[m++]:t),y=d.object(g,n,o,p,a,f,-1,-1);return[new u(l,y,null,!1,r),e-i+1]}const[m,g]=(0,s.readVarInt)(t,e);e=m;const[y,_]=(0,s.readVarInt)(t,e),A=t[e=y],v=A==c.PacketType.ENUMS?S[0]:A;console.log(l,v,t,e,t[e]);const P=d.single(v,g,_,p,f,-1,-1);return[new u(l,P,null,!1,r),e-i+1]}static deserializeAll(t,e){const r=[];let a=0;for(;a<t.length;){const[n,s]=this.deserialize(t,a,e);r.push(n),a+=s}return r}}e.Packet=u;class d{constructor(t){this.types=[],this.dataMaxes=[],this.dataMins=[],this.type=c.PacketType.NONE,this.dataMax=-1,this.dataMin=-1,this.dataBatching=0,this.maxBatchSize=10,this.rateLimit=0,this.enumData=[],this.dontSpread=!1,this.autoFlatten=!1,this.object=t}static single(t,e,r,a,n,s,i){const o=new d(!1);return"number"==typeof t?(o.type=t,t==c.PacketType.NONE&&(e=r=0)):(o.type=c.PacketType.ENUMS,o.enumData=[t]),o.dataMax=e,o.dataMin=r,o.dontSpread=a,o.dataBatching=n,o.maxBatchSize=s,o.rateLimit=i,o}static object(t,e,r,a,n,s,i,o){if(t.length!=e.length||t.length!=r.length)throw new Error("There is an inbalance between the amount of types, data maxes, and data mins!");const h=new d(!0);return t.forEach(t=>{"number"==typeof t?h.types.push(t):(h.types.push(c.PacketType.ENUMS),h.enumData.push(t))}),h.dataMaxes=e,h.dataMins=r,h.dontSpread=a,h.autoFlatten=n,h.dataBatching=s,h.maxBatchSize=i,h.rateLimit=o,h}}e.PacketSchema=d},943:(t,e,r)=>{Object.defineProperty(e,"__esModule",{value:!0}),e.decompressBools=e.compressBools=e.varIntOverflowPow=e.ONE_FOURTH=e.ONE_EIGHT=e.MAX_VARINT=e.MAX_UVARINT=e.MAX_VSECT_SIZE=e.VARINT_OVERFLOW=e.NEGATIVE_VARINT=e.VARINT_CHAIN_FLAG=e.UVARINT_OVERFLOW=e.MAX_INT_D=e.SHORT_OVERFLOW=e.SHORT_CC_OVERFLOW=e.NEGATIVE_SHORT=e.MAX_SHORT=e.BYTE_OVERFLOW=e.NEGATIVE_BYTE=e.MAX_BYTE=void 0,e.fromShort=o,e.toShort=c,e.toByte=function(t){if(!isFinite(t))throw new Error("Can only use real numbers in bytes: "+t);if(t>e.MAX_BYTE||t<-e.MAX_BYTE-1)throw new Error(`Byte Numbers must be within range -${e.MAX_BYTE+1} and ${e.MAX_BYTE}: ${t}`);return t},e.sectorSize=h,e.convertBase=l,e.convertFloat=function(t){if(isNaN(t))return y(0,E,1);const e=t<0?1:0;if(0==(t=Math.abs(t)))return y(e,0,0);const r=Math.floor(Math.log(t)/Math.LN2);if(r>127||r<-126)return y(e,255,0);const a=t/i(r),n=Math.round((a-1)*i(23));return y(e,r+127,8388607&n)},e.deconvertFloat=function(t){const e=t.map(t=>t.toString(2).padStart(8,"0")).join(""),r=d(e[0]),a=d(e.slice(1,9)),n=0==a?-126:a-127,s=function(t,e){const r=d(t);let a=0;for(let t=0;t<u;t++)r&1<<u-t-1&&(a+=i(-(t+1)));return(e?1:0)+a}(e.slice(9,32),0!=a);let o;o=a==E?0==s?1/0:NaN:s*i(n);return 1==r?-o:o},e.convertDouble=function(t){if(isNaN(t))return _(0,m,1);const e=t<0?1:0;if(!isFinite(t))return _(e,m,0);let r,a;0==(t=Math.abs(t))?(r=0,a=0):(r=Math.floor(Math.log2(t))-51,a=Math.floor(t/i(r)));return _(e,r+1023,a)},e.deconvertDouble=function(t){const e=t.map(t=>t.toString(2).padStart(8,"0")).join(""),r=d(e[0]),a=d(e.slice(1,12)),n=0==a?-1022:a-1023,s=d(e.slice(12,64));let o;o=a==m?0==s?1/0:NaN:s*i(n);return 1==r?-o:o},e.mapZigZag=A,e.demapZigZag=v,e.demapShort_ZZ=function(t){return v(o(t))},e.mapShort_ZZ=function(t){return c(A(t))},e.convertVarInt=function(t){if(t>e.MAX_UVARINT||t<0)throw new Error(`Variable Ints must be within range 0 and ${e.MAX_VARINT}: ${t}`);const r=h(t,e.varIntOverflowPow);return l(t,r,e.VARINT_OVERFLOW,e.UVARINT_OVERFLOW,e.varIntOverflowPow).map((t,r)=>0==r?t:t|e.VARINT_CHAIN_FLAG).reverse()},e.readVarInt=P,e.deconvertVarInts=function(t){let e=[],r=0;for(;r<t.length;){const[a,n]=P(t,r);e.push(n),r=a}return e};const a=r(282);e.MAX_BYTE=255,e.NEGATIVE_BYTE=Math.floor(e.MAX_BYTE/2),e.BYTE_OVERFLOW=e.NEGATIVE_BYTE+1,e.MAX_SHORT=65535,e.NEGATIVE_SHORT=Math.floor(e.MAX_SHORT/2),e.SHORT_CC_OVERFLOW=e.MAX_BYTE+1,e.SHORT_OVERFLOW=e.MAX_SHORT+1,e.MAX_INT_D=Number.MAX_SAFE_INTEGER,e.UVARINT_OVERFLOW=e.NEGATIVE_BYTE+1,e.VARINT_CHAIN_FLAG=128,e.NEGATIVE_VARINT=Math.floor(e.NEGATIVE_BYTE/2),e.VARINT_OVERFLOW=e.NEGATIVE_VARINT+1,e.MAX_VSECT_SIZE=7,e.MAX_UVARINT=Math.pow(e.UVARINT_OVERFLOW,e.MAX_VSECT_SIZE)-1,e.MAX_VARINT=Math.floor(e.MAX_UVARINT/2),e.ONE_EIGHT=1/8,e.ONE_FOURTH=1/4;const n=[];e.varIntOverflowPow=t=>{var r;return null!==(r=n[t])&&void 0!==r?r:n[t]=Math.pow(e.UVARINT_OVERFLOW,t)};const s=[],i=t=>{var e;return null!==(e=s[t])&&void 0!==e?e:s[t]=Math.pow(2,t)};for(let t=0;t<=3;t++)(0,e.varIntOverflowPow)(t);function o(t){return t[0]*e.SHORT_CC_OVERFLOW+t[1]}function c(t){if(!isFinite(t))throw new Error("Can only use real numbers in shorts: "+t);if(t>e.MAX_SHORT||t<0)throw new Error(`Short Numbers must be within range 0 and ${e.MAX_SHORT}`);return[Math.floor(t/e.SHORT_CC_OVERFLOW),t%e.SHORT_CC_OVERFLOW]}function h(t,e){t=Math.abs(t);let r=1;for(let a=e(1);t>=a;a=e(++r));return r}function l(t,r,a,n,s){if(!isFinite(t))throw new Error("Cannot use a non-finite number: "+t);if(0==t)return Array.from({length:r}).map(()=>0);if(1==r)return[t];const i=t<0;if((t=Math.abs(t))>e.MAX_INT_D)throw new Error(`Non-float numbers must be within range -${e.MAX_INT_D.toLocaleString()} and ${e.MAX_INT_D.toLocaleString()}: ${t}`);let o=[];const c=r-1;for(let e=0;e<c;e++){const r=s(c-e),a=Math.floor(t/r);o.push(a),t-=a*r}o.push(t%n);return i?o.map(t=>t>0?t+a:t):o}e.compressBools=t=>t.reduce((t,e,r)=>t|e<<7-r,0);e.decompressBools=t=>[...Array(8)].map((e,r)=>!!(t&1<<7-r));const u=23;function d(t){return parseInt(t,2)}const p=8,f=23,T=11,S=52,E=255,m=2047;function g(t,e,r,n,s){const i=r.toString(2)+n.toString(2).padStart(t,"0")+s.toString(2).padStart(e,"0");return(0,a.splitArray)(i,8).map(t=>d(t))}function y(t,e,r){return g(p,f,t,e,r)}function _(t,e,r){return g(T,S,t,e,r)}function A(t){return t<<1^t>>15}function v(t){return t>>>1^-(1&t)}function P(t,r){let a,n=[];do{const s=t[r++];a=0!=(s&e.VARINT_CHAIN_FLAG),n.push(a?s^e.VARINT_CHAIN_FLAG:s)}while(a);return[r,n.reduce((t,r,a)=>t+r*(0,e.varIntOverflowPow)(a),0)]}},958:(t,e)=>{function r(t){return String.fromCodePoint(...t)}function a(t){return t>=e.SURROGATE_MIN&&t<=e.SURROGATE_MAX}function n(t,e){return 1024*(t-55296)+(e-56320)+65536}Object.defineProperty(e,"__esModule",{value:!0}),e.MAX_UTF16=e.MAX_UTF8=e.SURROGATE_MAX=e.SURROGATE_MIN=void 0,e.processCharCodes=function(t){return Array.from(t,t=>t.codePointAt(0))},e.convertCharCodes=r,e.splitCodePoint=function(t){if(t<=e.MAX_UTF8){if(a(t))throw new Error(`Cannot send code point ${t}; must be out of range ${e.SURROGATE_MIN} and ${e.SURROGATE_MAX}`);return[t]}if(t>e.MAX_UTF16)throw new Error(`Cannot send code ${t}`);return[55296+((t-=65536)>>10),56320+(1023&t)]},e.pairToPoint=n,e.convertCodePoints=function(t){let e=[];for(let r=0;r<t.length;r++){const s=t[r];if(a(s)){if(r==t.length-1)throw new Error(`Terminated surrogate pair; index ${r} value ${s}`);const i=t[++r];if(!a(i))throw new Error(`Terminated surrogate pair; index ${r} value ${s} next value ${i}`);e.push(n(s,i));continue}e.push(s)}return r(e)},e.SURROGATE_MIN=55296,e.SURROGATE_MAX=57343,e.MAX_UTF8=65535,e.MAX_UTF16=1114111},977:(t,e,r)=>{Object.defineProperty(e,"__esModule",{value:!0}),e.EnumPackage=e.TYPE_CONVERSION_MAP=void 0;const a=r(958),n={string:0,number:1,boolean:2,undefined:3,object:4};function s(t){const e=typeof t;if(!(e in n)&&null!=t)throw new Error(`Cannot serialize type "${e}" in an enum!`);return n[e]}e.TYPE_CONVERSION_MAP={0:t=>t,1:t=>parseFloat(t),2:t=>"true"==t,3:()=>{},4:()=>null};e.EnumPackage=class{constructor(t,e){this.tag=t,this.values=e}serialize(){const t=(0,a.processCharCodes)(this.tag);return[this.tag.length,...t,this.values.length,...this.values.map(t=>[String(t).length,s(t),...(0,a.processCharCodes)(String(t))]).flat()]}}}},e={};(function r(a){var n=e[a];if(void 0!==n)return n.exports;var s=e[a]={exports:{}};return t[a].call(s.exports,s,s.exports,r),s.exports})(658)})();